<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Ultimate Space Shooter - Fixed HUD</title>
<style>
body{
  margin:0;
  height:100vh;
  background:radial-gradient(circle at top,#1e3c72,#0b1023);
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:Arial;
  color:white;
}
#box{
  padding:16px;
  border-radius:16px;
  background:linear-gradient(#111,#000);
  box-shadow:0 0 40px rgba(0,200,255,.4);
  width:460px;
}
canvas{
  background:linear-gradient(#020824,#000);
  border-radius:12px;
  display:block;
}
.tip{
  text-align:center;
  font-size:14px;
  opacity:.8;
}
#restartBtn{
  margin-top:10px;
  width:100%;
  padding:10px;
  font-size:16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,#00ffe0,#0070ff);
  color:#000;
  font-weight:bold;
}
#restartBtn:hover{opacity:.85;}
</style>
</head>

<body>
<div id="box">
  <h2 style="text-align:center;">ğŸš€ Ultimate Space Shooter</h2>
  <canvas id="game" width="440" height="560"></canvas>
  <div class="tip">â† â†’ ç§»å‹•ã€€ç©ºç™½éµå°„æ“Šã€€é»æ“Šç•«é¢é–‹å§‹</div>
  <button id="restartBtn">ğŸ”„ é‡æ–°é–‹å§‹</button>
</div>

<script>
/* ========= éŸ³æ•ˆ ========= */
const AC = new (window.AudioContext||window.webkitAudioContext)();
function play(freq,d=0.15,type="sawtooth",v=0.06){
  const o=AC.createOscillator(),g=AC.createGain();
  o.type=type;o.frequency.value=freq;
  g.gain.value=v;o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+d);
}
let musicTimer=null;
function startMusic(){
  if(musicTimer) return;
  const notes=[220,262,294,330,294,262];
  let i=0;
  musicTimer=setInterval(()=>{
    play(notes[i],0.25,"triangle",0.04);
    i=(i+1)%notes.length;
  },320);
}

/* ========= ç•«å¸ƒ ========= */
const c=document.getElementById("game");
const ctx=c.getContext("2d");

/* ========= ç‹€æ…‹ ========= */
let started=false,keys={},score=0;
document.onkeydown=e=>keys[e.code]=true;
document.onkeyup=e=>keys[e.code]=false;

c.onclick=()=>{
  AC.resume();
  started=true;
  startMusic();
};

/* ========= æ˜Ÿç©º ========= */
let stars=[...Array(80)].map(()=>({
  x:Math.random()*440,y:Math.random()*560,s:1+Math.random()*2
}));

/* ========= ç©å®¶ ========= */
const player={
  x:200,y:480,w:44,h:44,
  speed:6,lives:3,cool:0
};

/* ========= ç‰©ä»¶ ========= */
let bullets=[],enemies=[],particles=[];

/* ========= æ•µäºº ========= */
function spawnEnemy(){
  enemies.push({
    x:Math.random()*380,y:-40,w:44,h:30
  });
}
setInterval(()=>started && spawnEnemy(),900);

/* ========= ç©å®¶å°„æ“Š ========= */
function shoot(){
  if(player.cool<=0){
    bullets.push({x:player.x+19,y:player.y});
    play(600);
    player.cool=15;
  }
}

/* ========= çˆ†ç‚¸ ========= */
function explode(x,y,color){
  play(140,0.2,"triangle",0.12);
  for(let i=0;i<18;i++){
    particles.push({
      x,y,
      vx:(Math.random()-.5)*6,
      vy:(Math.random()-.5)*6,
      life:30,c:color
    });
  }
}

/* ========= æ›´æ–° ========= */
function update(){
  if(!started) return;

  if(keys.ArrowLeft && player.x>0) player.x-=player.speed;
  if(keys.ArrowRight && player.x<396) player.x+=player.speed;
  if(keys.Space) shoot();
  if(player.cool>0) player.cool--;

  bullets.forEach(b=>b.y-=9);
  enemies.forEach(e=>{
    e.y+=2; // æ•µäººåªæœƒå¾€ä¸‹ç§»å‹•ï¼Œä¸å°„æ“Š
  });

  // ç©å®¶å­å½ˆæ“Šä¸­æ•µäºº â†’ ä¸€ç™¼å°±æ­»
  bullets=bullets.filter(b=>{
    return !enemies.some((e,idx)=>{
      if(b.x<e.x+e.w && b.x+6>e.x && b.y<e.y+e.h && b.y+14>e.y){
        explode(e.x+e.w/2,e.y+e.h/2,"orange");
        enemies.splice(idx,1);
        score++;
        return true; // å­å½ˆæ¶ˆå¤±
      }
    });
  });

  enemies = enemies.filter(e=>e.y<600);

  // æ•µäººæ’ç©å®¶
  enemies = enemies.filter(e=>{
    if(e.x < player.x + player.w && e.x + e.w > player.x &&
       e.y < player.y + player.h && e.y + e.h > player.y){
      explode(player.x+22,player.y+22,"red");
      player.lives--;
      return false;
    }
    return true;
  });

  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.life--;
    return p.life>0;
  });

  stars.forEach(s=>{s.y+=s.s;if(s.y>560)s.y=0;});

  if(player.lives<=0) started=false;
}

/* ========= ç¹ªè£½ ========= */
function drawPlayer(){
  const g=ctx.createLinearGradient(player.x,player.y,player.x,player.y+44);
  g.addColorStop(0,"#00ffe0");
  g.addColorStop(1,"#0070ff");
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.moveTo(player.x+22,player.y);
  ctx.lineTo(player.x+44,player.y+44);
  ctx.lineTo(player.x+22,player.y+34);
  ctx.lineTo(player.x,player.y+44);
  ctx.closePath();ctx.fill();
  ctx.fillStyle="cyan";
  ctx.fillRect(player.x+18,player.y+44,8,10);
}

// å¸¥æ°£æ•µäººé£›èˆ¹
function drawEnemy(e){
  const g=ctx.createLinearGradient(e.x,e.y,e.x,e.y+e.h);
  g.addColorStop(0,"#ff5050");
  g.addColorStop(1,"#ff0000");
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.moveTo(e.x + e.w/2, e.y);
  ctx.lineTo(e.x + e.w, e.y + e.h);
  ctx.lineTo(e.x, e.y + e.h);
  ctx.closePath();
  ctx.fill();
}

function draw(){
  ctx.clearRect(0,0,440,560);

  // èƒŒæ™¯æ˜Ÿæ˜Ÿ
  ctx.fillStyle="white";
  stars.forEach(s=>ctx.fillRect(s.x,s.y,s.s,s.s));

  if(!started && player.lives>0){
    ctx.font="26px Arial";
    ctx.fillText("é»æ“Šç•«é¢é–‹å§‹",120,280);
    return;
  }

  // ç©å®¶
  drawPlayer();

  // ç©å®¶å­å½ˆ
  ctx.fillStyle="yellow";
  bullets.forEach(b=>{
    ctx.shadowBlur=10;
    ctx.shadowColor="yellow";
    ctx.fillRect(b.x,b.y,6,14);
  });
  ctx.shadowBlur=0;

  // æ•µäºº
  enemies.forEach(drawEnemy);

  // çˆ†ç‚¸ç²’å­
  particles.forEach(p=>{
    ctx.globalAlpha=p.life/30;
    ctx.fillStyle=p.c;
    ctx.fillRect(p.x,p.y,4,4);
    ctx.globalAlpha=1;
  });

  // -------- åˆ†æ•¸èˆ‡ç”Ÿå‘½æ¢ï¼Œæ°¸é åœ¨æœ€ä¸Šå±¤ --------
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.fillText("Score: "+score, 10, 30);
  ctx.fillText("â¤ï¸ ".repeat(player.lives), 320, 30);

  if(player.lives<=0){
    ctx.font="32px Arial";
    ctx.fillText("GAME OVER",110,300);
  }
}

/* ========= é‡æ–°é–‹å§‹ ========= */
document.getElementById("restartBtn").onclick=()=>{
  score=0;
  player.lives=3;
  player.x=200;
  bullets=[];
  enemies=[];
  particles=[];
  started=true;
};

/* ========= éŠæˆ²è¿´åœˆ ========= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
